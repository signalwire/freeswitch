#if defined(HAVE_CONFIG_H)
#include "config.h"
#endif
#include <stdlib.h>
#include <inttypes.h>
#include <memory.h>
#include <string.h>
#include <limits.h>

#include "fsk_detect.h"

void fsk_report(void *user_data, int bit);

void fsk_report_ex(void *user_data, unsigned char fsk);
/* This is a simple set of direct digital synthesis (DDS) functions to generate sine
   waves. This version uses a 256 entry sin/cos table to cover one quadrant. */

const fsk_spec_t preset_fsk_specs[] =
{
    {"V21 ch 1",    1080 + 100, 1080 - 100, -14,    -30,    300*100},
    {"V21 ch 2",    1750 + 100, 1750 - 100, -14,    -30,    300*100},
    /* This is mode 2 of the V.23 spec. Mode 1 (the 600baud mode) is not defined here */
    {"V23 ch 1",    1700 + 400, 1700 - 400, -14,    -30,    1200*100},
    {"V23 ch 2",    420 + 30,   420 - 30,   -14,    -30,    75*100},
    {"Bell103 ch 1",2125 - 100, 2125 + 100, -14,    -30,    300*100},
    {"Bell103 ch 2",1170 - 100, 1170 + 100, -14,    -30,    300*100},
    {"Bell202",     1700 + 500, 1700 - 500, -14,    -30,    1200*100},
    /* Used for US TDD (Telecoms Device for the Deaf) */
    {"Weitbrecht 45.45",1600 + 200,1600 - 200,-14,  -30,    4545},
    /* Used for international TDD (Telecoms Device for the Deaf) */
    {"Weitbrecht 50",1600 + 200,1600 - 200, -14,    -30,    50*100},
    /* Used for V.18 probing */
    {"Weitbrecht 47.6",1600 + 200,1600 - 200,-14,   -30,    4760},
    {"V21 (110bps) ch 1",1080 + 100,1080 - 100,-14, -30,    110*100}
};

static const int16_t sine_table[DDS_STEPS + 1] =
{
         0,
       201,
       402,
       603,
       804,
      1005,
      1206,
      1407,
      1608,
      1809,
      2009,
      2210,
      2410,
      2611,
      2811,
      3012,
      3212,
      3412,
      3612,
      3811,
      4011,
      4210,
      4410,
      4609,
      4808,
      5007,
      5205,
      5404,
      5602,
      5800,
      5998,
      6195,
      6393,
      6590,
      6786,
      6983,
      7179,
      7375,
      7571,
      7767,
      7962,
      8157,
      8351,
      8545,
      8739,
      8933,
      9126,
      9319,
      9512,
      9704,
      9896,
     10087,
     10278,
     10469,
     10659,
     10849,
     11039,
     11228,
     11417,
     11605,
     11793,
     11980,
     12167,
     12353,
     12539,
     12725,
     12910,
     13094,
     13279,
     13462,
     13645,
     13828,
     14010,
     14191,
     14372,
     14553,
     14732,
     14912,
     15090,
     15269,
     15446,
     15623,
     15800,
     15976,
     16151,
     16325,
     16499,
     16673,
     16846,
     17018,
     17189,
     17360,
     17530,
     17700,
     17869,
     18037,
     18204,
     18371,
     18537,
     18703,
     18868,
     19032,
     19195,
     19357,
     19519,
     19680,
     19841,
     20000,
     20159,
     20317,
     20475,
     20631,
     20787,
     20942,
     21096,
     21250,
     21403,
     21554,
     21705,
     21856,
     22005,
     22154,
     22301,
     22448,
     22594,
     22739,
     22884,
     23027,
     23170,
     23311,
     23452,
     23592,
     23731,
     23870,
     24007,
     24143,
     24279,
     24413,
     24547,
     24680,
     24811,
     24942,
     25072,
     25201,
     25329,
     25456,
     25582,
     25708,
     25832,
     25955,
     26077,
     26198,
     26319,
     26438,
     26556,
     26674,
     26790,
     26905,
     27019,
     27133,
     27245,
     27356,
     27466,
     27575,
     27683,
     27790,
     27896,
     28001,
     28105,
     28208,
     28310,
     28411,
     28510,
     28609,
     28706,
     28803,
     28898,
     28992,
     29085,
     29177,
     29268,
     29358,
     29447,
     29534,
     29621,
     29706,
     29791,
     29874,
     29956,
     30037,
     30117,
     30195,
     30273,
     30349,
     30424,
     30498,
     30571,
     30643,
     30714,
     30783,
     30852,
     30919,
     30985,
     31050,
     31113,
     31176,
     31237,
     31297,
     31356,
     31414,
     31470,
     31526,
     31580,
     31633,
     31685,
     31736,
     31785,
     31833,
     31880,
     31926,
     31971,
     32014,
     32057,
     32098,
     32137,
     32176,
     32213,
     32250,
     32285,
     32318,
     32351,
     32382,
     32412,
     32441,
     32469,
     32495,
     32521,
     32545,
     32567,
     32589,
     32609,
     32628,
     32646,
     32663,
     32678,
     32692,
     32705,
     32717,
     32728,
     32737,
     32745,
     32752,
     32757,
     32761,
     32765,
     32766,
     32767
};

enum
{
    FSK_FRAME_MODE_ASYNC = 0,
    FSK_FRAME_MODE_SYNC = 1,
    FSK_FRAME_MODE_5N1_FRAMES = 7,      /* 5 bits of data + start bit + stop bit */
    FSK_FRAME_MODE_7N1_FRAMES = 9,      /* 7 bits of data + start bit + stop bit */
    FSK_FRAME_MODE_7E1_FRAMES = 10,     /* 7 bits of data + even parity + start bit + stop bit */
    FSK_FRAME_MODE_7E2_FRAMES = 11      /* 7 bits of data + even parity + start bit + 2 stop bits */
};


/*! Special "bit" values for the bitstream put and get functions, and the signal status functions. */
enum
{
    /*! \brief The carrier signal has dropped. */
    SIG_STATUS_CARRIER_DOWN = -1,
    /*! \brief The carrier signal is up. This merely indicates that carrier
         energy has been seen. It is not an indication that the carrier is either
         valid, or of the expected type. */
    SIG_STATUS_CARRIER_UP = -2,
    /*! \brief The modem is training. This is an early indication that the
        signal seems to be of the right type. This may be needed in time critical
        applications, like T.38, to forward an early indication of what is happening
        on the wire. */
    SIG_STATUS_TRAINING_IN_PROGRESS = -3,
    /*! \brief The modem has trained, and is ready for data exchange. */
    SIG_STATUS_TRAINING_SUCCEEDED = -4,
    /*! \brief The modem has failed to train. */
    SIG_STATUS_TRAINING_FAILED = -5,
    /*! \brief Packet framing (e.g. HDLC framing) is OK. */
    SIG_STATUS_FRAMING_OK = -6,
    /*! \brief The data stream has ended. */
    SIG_STATUS_END_OF_DATA = -7,
    /*! \brief An abort signal (e.g. an HDLC abort) has been received. */
    SIG_STATUS_ABORT = -8,
    /*! \brief A break signal (e.g. an async break) has been received. */
    SIG_STATUS_BREAK = -9,
    /*! \brief A modem has completed its task, and shut down. */
    SIG_STATUS_SHUTDOWN_COMPLETE = -10,
    /*! \brief Regular octet report for things like HDLC to the MTP standards. */
    SIG_STATUS_OCTET_REPORT = -11,
    /*! \brief Notification that a modem has detected signal quality degradation. */
    SIG_STATUS_POOR_SIGNAL_QUALITY = -12,
    /*! \brief Notification that a modem retrain has occurred. */
    SIG_STATUS_MODEM_RETRAIN_OCCURRED = -13,
    /*! \brief The link protocol (e.g. V.42) has connected. */
    SIG_STATUS_LINK_CONNECTED = -14,
    /*! \brief The link protocol (e.g. V.42) has disconnected. */
    SIG_STATUS_LINK_DISCONNECTED = -15,
    /*! \brief An error has occurred in the link protocol (e.g. V.42). */
    SIG_STATUS_LINK_ERROR = -16,
    /*! \brief Keep the link in an idle state, as there is nothing to send. */
    SIG_STATUS_LINK_IDLE = -17
};

FskPara gFSKPara = {2200, 1200, -60, 1200,96,32,24};


#ifndef SPANDSP_USE_FIXED_POINT
static int32_t power_meter_level_dbm0(float level)
{
    float l;

    level -= DBM0_MAX_POWER;
    if (level > 0.0)
        level = 0.0;
    l = powf(10.0f, level/10.0f)*(32767.0f*32767.0f);
    return (int32_t) l;
}
#endif

#define FSK_MIN_LEVEL_COUNT         128
static const int32_t FSK_ON_POWER_TBL[FSK_MIN_LEVEL_COUNT+1] =
{
115046488, 91384680, 72589424, 57659832, 45800832, 36380896, 28898372, 22954788, 18233638, 14483492,    //   0 -->   9
 11504647,  9138465,  7258941,  5765982,  4580082,  3638088,  2889836,  2295479,  1823363,  1448349,    //  10 -->  19
  1150464,   913846,   725894,   576598,   458008,   363808,   288983,   229547,   182336,   144834,    //  20 -->  29
   115046,    91384,    72589,    57659,    45800,    36380,    28898,    22954,    18233,    14483,    //  30 -->  39
    11504,     9138,     7258,     5765,     4580,     3638,     2889,     2295,     1823,     1448,    //  40 -->  49
     1150,      913,      725,      576,      458,      363,      288,      229,      182,      144,    //  50 -->  59
      115,       91,       72,       57,       45,       36,       28,       22,       18,       14,    //  60 -->  69
       11,        9,        7,        5,        4,        3,        2,        2,        1,        1,    //  70 -->  79
        1,        0,        0,        0,        0,        0,        0,        0,        0,        0,    //  80 -->  89
};
static const int32_t FSK_OFF_POWER_TBL[FSK_MIN_LEVEL_COUNT+1] = 
{
 36380896, 28898372, 22954788, 18233638, 14483492, 11504647,  9138465,  7258941,  5765982,  4580082,    //   0 -->   9
  3638088,  2889836,  2295479,  1823363,  1448349,  1150464,   913846,   725894,   576598,   458008,    //  10 -->  19
   363808,   288983,   229547,   182336,   144834,   115046,    91384,    72589,    57659,    45800,    //  20 -->  29
    36380,    28898,    22954,    18233,    14483,    11504,     9138,     7258,     5765,     4580,    //  30 -->  39
     3638,     2889,     2295,     1823,     1448,     1150,      913,      725,      576,      458,    //  40 -->  49
      363,      288,      229,      182,      144,      115,       91,       72,       57,       45,    //  50 -->  59
       36,       28,       22,       18,       14,       11,        9,        7,        5,        4,    //  60 -->  69
        3,        2,        2,        1,        1,        1,        0,        0,        0,        0,    //  70 -->  79
};

static const int32_t FSK_DDS_PHASE_RATE[SAMPLE_RATE/2] = 
{
        0,   536870,  1073741,  1610612,  2147483,  2684354,  3221225,  3758096,  4294967,  4831838,    //   0 -->   9
  5368709,  5905580,  6442450,  6979321,  7516192,  8053063,  8589934,  9126805,  9663676, 10200547,    //  10 -->  19
 10737418, 11274289, 11811160, 12348030, 12884901, 13421772, 13958643, 14495514, 15032385, 15569256,    //  20 -->  29
 16106127, 16642998, 17179869, 17716740, 18253611, 18790481, 19327352, 19864223, 20401094, 20937965,    //  30 -->  39
 21474836, 22011707, 22548578, 23085449, 23622320, 24159191, 24696061, 25232932, 25769803, 26306674,    //  40 -->  49
 26843545, 27380416, 27917287, 28454158, 28991029, 29527900, 30064771, 30601641, 31138512, 31675383,    //  50 -->  59
 32212254, 32749125, 33285996, 33822867, 34359738, 34896609, 35433480, 35970351, 36507222, 37044092,    //  60 -->  69
 37580963, 38117834, 38654705, 39191576, 39728447, 40265318, 40802189, 41339060, 41875931, 42412802,    //  70 -->  79
 42949672, 43486543, 44023414, 44560285, 45097156, 45634027, 46170898, 46707769, 47244640, 47781511,    //  80 -->  89
 48318382, 48855252, 49392123, 49928994, 50465865, 51002736, 51539607, 52076478, 52613349, 53150220,    //  90 -->  99
 53687091, 54223962, 54760833, 55297703, 55834574, 56371445, 56908316, 57445187, 57982058, 58518929,    // 100 --> 109
 59055800, 59592671, 60129542, 60666413, 61203283, 61740154, 62277025, 62813896, 63350767, 63887638,    // 110 --> 119
 64424509, 64961380, 65498251, 66035122, 66571993, 67108864, 67645734, 68182605, 68719476, 69256347,    // 120 --> 129
 69793218, 70330089, 70866960, 71403831, 71940702, 72477573, 73014444, 73551314, 74088185, 74625056,    // 130 --> 139
 75161927, 75698798, 76235669, 76772540, 77309411, 77846282, 78383153, 78920024, 79456894, 79993765,    // 140 --> 149
 80530636, 81067507, 81604378, 82141249, 82678120, 83214991, 83751862, 84288733, 84825604, 85362475,    // 150 --> 159
 85899345, 86436216, 86973087, 87509958, 88046829, 88583700, 89120571, 89657442, 90194313, 90731184,    // 160 --> 169
 91268055, 91804925, 92341796, 92878667, 93415538, 93952409, 94489280, 95026151, 95563022, 96099893,    // 170 --> 179
 96636764, 97173635, 97710505, 98247376, 98784247, 99321118, 99857989,100394860,100931731,101468602,    // 180 --> 189
102005473,102542344,103079215,103616086,104152956,104689827,105226698,105763569,106300440,106837311,    // 190 --> 199
107374182,107911053,108447924,108984795,109521666,110058536,110595407,111132278,111669149,112206020,    // 200 --> 209
112742891,113279762,113816633,114353504,114890375,115427246,115964116,116500987,117037858,117574729,    // 210 --> 219
118111600,118648471,119185342,119722213,120259084,120795955,121332826,121869697,122406567,122943438,    // 220 --> 229
123480309,124017180,124554051,125090922,125627793,126164664,126701535,127238406,127775277,128312147,    // 230 --> 239
128849018,129385889,129922760,130459631,130996502,131533373,132070244,132607115,133143986,133680857,    // 240 --> 249
134217728,134754598,135291469,135828340,136365211,136902082,137438953,137975824,138512695,139049566,    // 250 --> 259
139586437,140123308,140660178,141197049,141733920,142270791,142807662,143344533,143881404,144418275,    // 260 --> 269
144955146,145492017,146028888,146565758,147102629,147639500,148176371,148713242,149250113,149786984,    // 270 --> 279
150323855,150860726,151397597,151934468,152471339,153008209,153545080,154081951,154618822,155155693,    // 280 --> 289
155692564,156229435,156766306,157303177,157840048,158376919,158913789,159450660,159987531,160524402,    // 290 --> 299
161061273,161598144,162135015,162671886,163208757,163745628,164282499,164819369,165356240,165893111,    // 300 --> 309
166429982,166966853,167503724,168040595,168577466,169114337,169651208,170188079,170724950,171261820,    // 310 --> 319
171798691,172335562,172872433,173409304,173946175,174483046,175019917,175556788,176093659,176630530,    // 320 --> 329
177167400,177704271,178241142,178778013,179314884,179851755,180388626,180925497,181462368,181999239,    // 330 --> 339
182536110,183072980,183609851,184146722,184683593,185220464,185757335,186294206,186831077,187367948,    // 340 --> 349
187904819,188441690,188978561,189515431,190052302,190589173,191126044,191662915,192199786,192736657,    // 350 --> 359
193273528,193810399,194347270,194884141,195421011,195957882,196494753,197031624,197568495,198105366,    // 360 --> 369
198642237,199179108,199715979,200252850,200789721,201326592,201863462,202400333,202937204,203474075,    // 370 --> 379
204010946,204547817,205084688,205621559,206158430,206695301,207232172,207769042,208305913,208842784,    // 380 --> 389
209379655,209916526,210453397,210990268,211527139,212064010,212600881,213137752,213674622,214211493,    // 390 --> 399
214748364,215285235,215822106,216358977,216895848,217432719,217969590,218506461,219043332,219580203,    // 400 --> 409
220117073,220653944,221190815,221727686,222264557,222801428,223338299,223875170,224412041,224948912,    // 410 --> 419
225485783,226022653,226559524,227096395,227633266,228170137,228707008,229243879,229780750,230317621,    // 420 --> 429
230854492,231391363,231928233,232465104,233001975,233538846,234075717,234612588,235149459,235686330,    // 430 --> 439
236223201,236760072,237296943,237833814,238370684,238907555,239444426,239981297,240518168,241055039,    // 440 --> 449
241591910,242128781,242665652,243202523,243739394,244276264,244813135,245350006,245886877,246423748,    // 450 --> 459
246960619,247497490,248034361,248571232,249108103,249644974,250181844,250718715,251255586,251792457,    // 460 --> 469
252329328,252866199,253403070,253939941,254476812,255013683,255550554,256087425,256624295,257161166,    // 470 --> 479
257698037,258234908,258771779,259308650,259845521,260382392,260919263,261456134,261993005,262529875,    // 480 --> 489
263066746,263603617,264140488,264677359,265214230,265751101,266287972,266824843,267361714,267898585,    // 490 --> 499
268435456,268972326,269509197,270046068,270582939,271119810,271656681,272193552,272730423,273267294,    // 500 --> 509
273804165,274341036,274877906,275414777,275951648,276488519,277025390,277562261,278099132,278636003,    // 510 --> 519
279172874,279709745,280246616,280783486,281320357,281857228,282394099,282930970,283467841,284004712,    // 520 --> 529
284541583,285078454,285615325,286152196,286689067,287225937,287762808,288299679,288836550,289373421,    // 530 --> 539
289910292,290447163,290984034,291520905,292057776,292594647,293131517,293668388,294205259,294742130,    // 540 --> 549
295279001,295815872,296352743,296889614,297426485,297963356,298500227,299037097,299573968,300110839,    // 550 --> 559
300647710,301184581,301721452,302258323,302795194,303332065,303868936,304405807,304942678,305479548,    // 560 --> 569
306016419,306553290,307090161,307627032,308163903,308700774,309237645,309774516,310311387,310848258,    // 570 --> 579
311385128,311921999,312458870,312995741,313532612,314069483,314606354,315143225,315680096,316216967,    // 580 --> 589
316753838,317290708,317827579,318364450,318901321,319438192,319975063,320511934,321048805,321585676,    // 590 --> 599
322122547,322659418,323196289,323733159,324270030,324806901,325343772,325880643,326417514,326954385,    // 600 --> 609
327491256,328028127,328564998,329101869,329638739,330175610,330712481,331249352,331786223,332323094,    // 610 --> 619
332859965,333396836,333933707,334470578,335007449,335544320,336081190,336618061,337154932,337691803,    // 620 --> 629
338228674,338765545,339302416,339839287,340376158,340913029,341449900,341986770,342523641,343060512,    // 630 --> 639
343597383,344134254,344671125,345207996,345744867,346281738,346818609,347355480,347892350,348429221,    // 640 --> 649
348966092,349502963,350039834,350576705,351113576,351650447,352187318,352724189,353261060,353797931,    // 650 --> 659
354334801,354871672,355408543,355945414,356482285,357019156,357556027,358092898,358629769,359166640,    // 660 --> 669
359703511,360240381,360777252,361314123,361850994,362387865,362924736,363461607,363998478,364535349,    // 670 --> 679
365072220,365609091,366145961,366682832,367219703,367756574,368293445,368830316,369367187,369904058,    // 680 --> 689
370440929,370977800,371514671,372051542,372588412,373125283,373662154,374199025,374735896,375272767,    // 690 --> 699
375809638,376346509,376883380,377420251,377957122,378493992,379030863,379567734,380104605,380641476,    // 700 --> 709
381178347,381715218,382252089,382788960,383325831,383862702,384399572,384936443,385473314,386010185,    // 710 --> 719
386547056,387083927,387620798,388157669,388694540,389231411,389768282,390305153,390842023,391378894,    // 720 --> 729
391915765,392452636,392989507,393526378,394063249,394600120,395136991,395673862,396210733,396747603,    // 730 --> 739
397284474,397821345,398358216,398895087,399431958,399968829,400505700,401042571,401579442,402116313,    // 740 --> 749
402653184,403190054,403726925,404263796,404800667,405337538,405874409,406411280,406948151,407485022,    // 750 --> 759
408021893,408558764,409095634,409632505,410169376,410706247,411243118,411779989,412316860,412853731,    // 760 --> 769
413390602,413927473,414464344,415001214,415538085,416074956,416611827,417148698,417685569,418222440,    // 770 --> 779
418759311,419296182,419833053,420369924,420906795,421443665,421980536,422517407,423054278,423591149,    // 780 --> 789
424128020,424664891,425201762,425738633,426275504,426812375,427349245,427886116,428422987,428959858,    // 790 --> 799
429496729,430033600,430570471,431107342,431644213,432181084,432717955,433254825,433791696,434328567,    // 800 --> 809
434865438,435402309,435939180,436476051,437012922,437549793,438086664,438623535,439160406,439697276,    // 810 --> 819
440234147,440771018,441307889,441844760,442381631,442918502,443455373,443992244,444529115,445065986,    // 820 --> 829
445602856,446139727,446676598,447213469,447750340,448287211,448824082,449360953,449897824,450434695,    // 830 --> 839
450971566,451508436,452045307,452582178,453119049,453655920,454192791,454729662,455266533,455803404,    // 840 --> 849
456340275,456877146,457414017,457950887,458487758,459024629,459561500,460098371,460635242,461172113,    // 850 --> 859
461708984,462245855,462782726,463319597,463856467,464393338,464930209,465467080,466003951,466540822,    // 860 --> 869
467077693,467614564,468151435,468688306,469225177,469762048,470298918,470835789,471372660,471909531,    // 870 --> 879
472446402,472983273,473520144,474057015,474593886,475130757,475667628,476204498,476741369,477278240,    // 880 --> 889
477815111,478351982,478888853,479425724,479962595,480499466,481036337,481573208,482110078,482646949,    // 890 --> 899
483183820,483720691,484257562,484794433,485331304,485868175,486405046,486941917,487478788,488015659,    // 900 --> 909
488552529,489089400,489626271,490163142,490700013,491236884,491773755,492310626,492847497,493384368,    // 910 --> 919
493921239,494458109,494994980,495531851,496068722,496605593,497142464,497679335,498216206,498753077,    // 920 --> 929
499289948,499826819,500363689,500900560,501437431,501974302,502511173,503048044,503584915,504121786,    // 930 --> 939
504658657,505195528,505732399,506269270,506806140,507343011,507879882,508416753,508953624,509490495,    // 940 --> 949
510027366,510564237,511101108,511637979,512174850,512711720,513248591,513785462,514322333,514859204,    // 950 --> 959
515396075,515932946,516469817,517006688,517543559,518080430,518617300,519154171,519691042,520227913,    // 960 --> 969
520764784,521301655,521838526,522375397,522912268,523449139,523986010,524522881,525059751,525596622,    // 970 --> 979
526133493,526670364,527207235,527744106,528280977,528817848,529354719,529891590,530428461,530965331,    // 980 --> 989
531502202,532039073,532575944,533112815,533649686,534186557,534723428,535260299,535797170,536334041,    // 990 --> 999
536870912,537407782,537944653,538481524,539018395,539555266,540092137,540629008,541165879,541702750,    // 1000 --> 1009
542239621,542776492,543313362,543850233,544387104,544923975,545460846,545997717,546534588,547071459,    // 1010 --> 1019
547608330,548145201,548682072,549218942,549755813,550292684,550829555,551366426,551903297,552440168,    // 1020 --> 1029
552977039,553513910,554050781,554587652,555124523,555661393,556198264,556735135,557272006,557808877,    // 1030 --> 1039
558345748,558882619,559419490,559956361,560493232,561030103,561566973,562103844,562640715,563177586,    // 1040 --> 1049
563714457,564251328,564788199,565325070,565861941,566398812,566935683,567472553,568009424,568546295,    // 1050 --> 1059
569083166,569620037,570156908,570693779,571230650,571767521,572304392,572841263,573378134,573915004,    // 1060 --> 1069
574451875,574988746,575525617,576062488,576599359,577136230,577673101,578209972,578746843,579283714,    // 1070 --> 1079
579820584,580357455,580894326,581431197,581968068,582504939,583041810,583578681,584115552,584652423,    // 1080 --> 1089
585189294,585726164,586263035,586799906,587336777,587873648,588410519,588947390,589484261,590021132,    // 1090 --> 1099
590558003,591094874,591631745,592168615,592705486,593242357,593779228,594316099,594852970,595389841,    // 1100 --> 1109
595926712,596463583,597000454,597537325,598074195,598611066,599147937,599684808,600221679,600758550,    // 1110 --> 1119
601295421,601832292,602369163,602906034,603442905,603979776,604516646,605053517,605590388,606127259,    // 1120 --> 1129
606664130,607201001,607737872,608274743,608811614,609348485,609885356,610422226,610959097,611495968,    // 1130 --> 1139
612032839,612569710,613106581,613643452,614180323,614717194,615254065,615790936,616327806,616864677,    // 1140 --> 1149
617401548,617938419,618475290,619012161,619549032,620085903,620622774,621159645,621696516,622233387,    // 1150 --> 1159
622770257,623307128,623843999,624380870,624917741,625454612,625991483,626528354,627065225,627602096,    // 1160 --> 1169
628138967,628675837,629212708,629749579,630286450,630823321,631360192,631897063,632433934,632970805,    // 1170 --> 1179
633507676,634044547,634581417,635118288,635655159,636192030,636728901,637265772,637802643,638339514,    // 1180 --> 1189
638876385,639413256,639950127,640486998,641023868,641560739,642097610,642634481,643171352,643708223,    // 1190 --> 1199
644245094,644781965,645318836,645855707,646392578,646929448,647466319,648003190,648540061,649076932,    // 1200 --> 1209
649613803,650150674,650687545,651224416,651761287,652298158,652835028,653371899,653908770,654445641,    // 1210 --> 1219
654982512,655519383,656056254,656593125,657129996,657666867,658203738,658740609,659277479,659814350,    // 1220 --> 1229
660351221,660888092,661424963,661961834,662498705,663035576,663572447,664109318,664646189,665183059,    // 1230 --> 1239
665719930,666256801,666793672,667330543,667867414,668404285,668941156,669478027,670014898,670551769,    // 1240 --> 1249
671088640,671625510,672162381,672699252,673236123,673772994,674309865,674846736,675383607,675920478,    // 1250 --> 1259
676457349,676994220,677531090,678067961,678604832,679141703,679678574,680215445,680752316,681289187,    // 1260 --> 1269
681826058,682362929,682899800,683436670,683973541,684510412,685047283,685584154,686121025,686657896,    // 1270 --> 1279
687194767,687731638,688268509,688805380,689342251,689879121,690415992,690952863,691489734,692026605,    // 1280 --> 1289
692563476,693100347,693637218,694174089,694710960,695247831,695784701,696321572,696858443,697395314,    // 1290 --> 1299
697932185,698469056,699005927,699542798,700079669,700616540,701153411,701690281,702227152,702764023,    // 1300 --> 1309
703300894,703837765,704374636,704911507,705448378,705985249,706522120,707058991,707595862,708132732,    // 1310 --> 1319
708669603,709206474,709743345,710280216,710817087,711353958,711890829,712427700,712964571,713501442,    // 1320 --> 1329
714038312,714575183,715112054,715648925,716185796,716722667,717259538,717796409,718333280,718870151,    // 1330 --> 1339
719407022,719943892,720480763,721017634,721554505,722091376,722628247,723165118,723701989,724238860,    // 1340 --> 1349
724775731,725312602,725849473,726386343,726923214,727460085,727996956,728533827,729070698,729607569,    // 1350 --> 1359
730144440,730681311,731218182,731755053,732291923,732828794,733365665,733902536,734439407,734976278,    // 1360 --> 1369
735513149,736050020,736586891,737123762,737660633,738197504,738734374,739271245,739808116,740344987,    // 1370 --> 1379
740881858,741418729,741955600,742492471,743029342,743566213,744103084,744639954,745176825,745713696,    // 1380 --> 1389
746250567,746787438,747324309,747861180,748398051,748934922,749471793,750008664,750545534,751082405,    // 1390 --> 1399
751619276,752156147,752693018,753229889,753766760,754303631,754840502,755377373,755914244,756451115,    // 1400 --> 1409
756987985,757524856,758061727,758598598,759135469,759672340,760209211,760746082,761282953,761819824,    // 1410 --> 1419
762356695,762893565,763430436,763967307,764504178,765041049,765577920,766114791,766651662,767188533,    // 1420 --> 1429
767725404,768262275,768799145,769336016,769872887,770409758,770946629,771483500,772020371,772557242,    // 1430 --> 1439
773094113,773630984,774167855,774704726,775241596,775778467,776315338,776852209,777389080,777925951,    // 1440 --> 1449
778462822,778999693,779536564,780073435,780610306,781147176,781684047,782220918,782757789,783294660,    // 1450 --> 1459
783831531,784368402,784905273,785442144,785979015,786515886,787052756,787589627,788126498,788663369,    // 1460 --> 1469
789200240,789737111,790273982,790810853,791347724,791884595,792421466,792958337,793495207,794032078,    // 1470 --> 1479
794568949,795105820,795642691,796179562,796716433,797253304,797790175,798327046,798863917,799400787,    // 1480 --> 1489
799937658,800474529,801011400,801548271,802085142,802622013,803158884,803695755,804232626,804769497,    // 1490 --> 1499
805306368,805843238,806380109,806916980,807453851,807990722,808527593,809064464,809601335,810138206,    // 1500 --> 1509
810675077,811211948,811748818,812285689,812822560,813359431,813896302,814433173,814970044,815506915,    // 1510 --> 1519
816043786,816580657,817117528,817654398,818191269,818728140,819265011,819801882,820338753,820875624,    // 1520 --> 1529
821412495,821949366,822486237,823023108,823559979,824096849,824633720,825170591,825707462,826244333,    // 1530 --> 1539
826781204,827318075,827854946,828391817,828928688,829465559,830002429,830539300,831076171,831613042,    // 1540 --> 1549
832149913,832686784,833223655,833760526,834297397,834834268,835371139,835908009,836444880,836981751,    // 1550 --> 1559
837518622,838055493,838592364,839129235,839666106,840202977,840739848,841276719,841813590,842350460,    // 1560 --> 1569
842887331,843424202,843961073,844497944,845034815,845571686,846108557,846645428,847182299,847719170,    // 1570 --> 1579
848256040,848792911,849329782,849866653,850403524,850940395,851477266,852014137,852551008,853087879,    // 1580 --> 1589
853624750,854161620,854698491,855235362,855772233,856309104,856845975,857382846,857919717,858456588,    // 1590 --> 1599
858993459,859530330,860067201,860604071,861140942,861677813,862214684,862751555,863288426,863825297,    // 1600 --> 1609
864362168,864899039,865435910,865972781,866509651,867046522,867583393,868120264,868657135,869194006,    // 1610 --> 1619
869730877,870267748,870804619,871341490,871878361,872415232,872952102,873488973,874025844,874562715,    // 1620 --> 1629
875099586,875636457,876173328,876710199,877247070,877783941,878320812,878857682,879394553,879931424,    // 1630 --> 1639
880468295,881005166,881542037,882078908,882615779,883152650,883689521,884226392,884763262,885300133,    // 1640 --> 1649
885837004,886373875,886910746,887447617,887984488,888521359,889058230,889595101,890131972,890668843,    // 1650 --> 1659
891205713,891742584,892279455,892816326,893353197,893890068,894426939,894963810,895500681,896037552,    // 1660 --> 1669
896574423,897111293,897648164,898185035,898721906,899258777,899795648,900332519,900869390,901406261,    // 1670 --> 1679
901943132,902480003,903016873,903553744,904090615,904627486,905164357,905701228,906238099,906774970,    // 1680 --> 1689
907311841,907848712,908385583,908922454,909459324,909996195,910533066,911069937,911606808,912143679,    // 1690 --> 1699
912680550,913217421,913754292,914291163,914828034,915364904,915901775,916438646,916975517,917512388,    // 1700 --> 1709
918049259,918586130,919123001,919659872,920196743,920733614,921270484,921807355,922344226,922881097,    // 1710 --> 1719
923417968,923954839,924491710,925028581,925565452,926102323,926639194,927176065,927712935,928249806,    // 1720 --> 1729
928786677,929323548,929860419,930397290,930934161,931471032,932007903,932544774,933081645,933618515,    // 1730 --> 1739
934155386,934692257,935229128,935765999,936302870,936839741,937376612,937913483,938450354,938987225,    // 1740 --> 1749
939524096,940060966,940597837,941134708,941671579,942208450,942745321,943282192,943819063,944355934,    // 1750 --> 1759
944892805,945429676,945966546,946503417,947040288,947577159,948114030,948650901,949187772,949724643,    // 1760 --> 1769
950261514,950798385,951335256,951872126,952408997,952945868,953482739,954019610,954556481,955093352,    // 1770 --> 1779
955630223,956167094,956703965,957240836,957777707,958314577,958851448,959388319,959925190,960462061,    // 1780 --> 1789
960998932,961535803,962072674,962609545,963146416,963683287,964220157,964757028,965293899,965830770,    // 1790 --> 1799
966367641,966904512,967441383,967978254,968515125,969051996,969588867,970125737,970662608,971199479,    // 1800 --> 1809
971736350,972273221,972810092,973346963,973883834,974420705,974957576,975494447,976031318,976568188,    // 1810 --> 1819
977105059,977641930,978178801,978715672,979252543,979789414,980326285,980863156,981400027,981936898,    // 1820 --> 1829
982473768,983010639,983547510,984084381,984621252,985158123,985694994,986231865,986768736,987305607,    // 1830 --> 1839
987842478,988379348,988916219,989453090,989989961,990526832,991063703,991600574,992137445,992674316,    // 1840 --> 1849
993211187,993748058,994284929,994821799,995358670,995895541,996432412,996969283,997506154,998043025,    // 1850 --> 1859
998579896,999116767,999653638,1000190509,1000727379,1001264250,1001801121,1002337992,1002874863,1003411734,    // 1860 --> 1869
1003948605,1004485476,1005022347,1005559218,1006096089,1006632960,1007169830,1007706701,1008243572,1008780443,    // 1870 --> 1879
1009317314,1009854185,1010391056,1010927927,1011464798,1012001669,1012538540,1013075410,1013612281,1014149152,    // 1880 --> 1889
1014686023,1015222894,1015759765,1016296636,1016833507,1017370378,1017907249,1018444120,1018980990,1019517861,    // 1890 --> 1899
1020054732,1020591603,1021128474,1021665345,1022202216,1022739087,1023275958,1023812829,1024349700,1024886571,    // 1900 --> 1909
1025423441,1025960312,1026497183,1027034054,1027570925,1028107796,1028644667,1029181538,1029718409,1030255280,    // 1910 --> 1919
1030792151,1031329021,1031865892,1032402763,1032939634,1033476505,1034013376,1034550247,1035087118,1035623989,    // 1920 --> 1929
1036160860,1036697731,1037234601,1037771472,1038308343,1038845214,1039382085,1039918956,1040455827,1040992698,    // 1930 --> 1939
1041529569,1042066440,1042603311,1043140182,1043677052,1044213923,1044750794,1045287665,1045824536,1046361407,    // 1940 --> 1949
1046898278,1047435149,1047972020,1048508891,1049045762,1049582632,1050119503,1050656374,1051193245,1051730116,    // 1950 --> 1959
1052266987,1052803858,1053340729,1053877600,1054414471,1054951342,1055488212,1056025083,1056561954,1057098825,    // 1960 --> 1969
1057635696,1058172567,1058709438,1059246309,1059783180,1060320051,1060856922,1061393793,1061930663,1062467534,    // 1970 --> 1979
1063004405,1063541276,1064078147,1064615018,1065151889,1065688760,1066225631,1066762502,1067299373,1067836243,    // 1980 --> 1989
1068373114,1068909985,1069446856,1069983727,1070520598,1071057469,1071594340,1072131211,1072668082,1073204953,    // 1990 --> 1999
1073741824,1074278694,1074815565,1075352436,1075889307,1076426178,1076963049,1077499920,1078036791,1078573662,    // 2000 --> 2009
1079110533,1079647404,1080184274,1080721145,1081258016,1081794887,1082331758,1082868629,1083405500,1083942371,    // 2010 --> 2019
1084479242,1085016113,1085552984,1086089854,1086626725,1087163596,1087700467,1088237338,1088774209,1089311080,    // 2020 --> 2029
1089847951,1090384822,1090921693,1091458564,1091995435,1092532305,1093069176,1093606047,1094142918,1094679789,    // 2030 --> 2039
1095216660,1095753531,1096290402,1096827273,1097364144,1097901015,1098437885,1098974756,1099511627,1100048498,    // 2040 --> 2049
1100585369,1101122240,1101659111,1102195982,1102732853,1103269724,1103806595,1104343465,1104880336,1105417207,    // 2050 --> 2059
1105954078,1106490949,1107027820,1107564691,1108101562,1108638433,1109175304,1109712175,1110249046,1110785916,    // 2060 --> 2069
1111322787,1111859658,1112396529,1112933400,1113470271,1114007142,1114544013,1115080884,1115617755,1116154626,    // 2070 --> 2079
1116691496,1117228367,1117765238,1118302109,1118838980,1119375851,1119912722,1120449593,1120986464,1121523335,    // 2080 --> 2089
1122060206,1122597076,1123133947,1123670818,1124207689,1124744560,1125281431,1125818302,1126355173,1126892044,    // 2090 --> 2099
1127428915,1127965786,1128502657,1129039527,1129576398,1130113269,1130650140,1131187011,1131723882,1132260753,    // 2100 --> 2109
1132797624,1133334495,1133871366,1134408237,1134945107,1135481978,1136018849,1136555720,1137092591,1137629462,    // 2110 --> 2119
1138166333,1138703204,1139240075,1139776946,1140313817,1140850688,1141387558,1141924429,1142461300,1142998171,    // 2120 --> 2129
1143535042,1144071913,1144608784,1145145655,1145682526,1146219397,1146756268,1147293138,1147830009,1148366880,    // 2130 --> 2139
1148903751,1149440622,1149977493,1150514364,1151051235,1151588106,1152124977,1152661848,1153198718,1153735589,    // 2140 --> 2149
1154272460,1154809331,1155346202,1155883073,1156419944,1156956815,1157493686,1158030557,1158567428,1159104299,    // 2150 --> 2159
1159641169,1160178040,1160714911,1161251782,1161788653,1162325524,1162862395,1163399266,1163936137,1164473008,    // 2160 --> 2169
1165009879,1165546749,1166083620,1166620491,1167157362,1167694233,1168231104,1168767975,1169304846,1169841717,    // 2170 --> 2179
1170378588,1170915459,1171452329,1171989200,1172526071,1173062942,1173599813,1174136684,1174673555,1175210426,    // 2180 --> 2189
1175747297,1176284168,1176821039,1177357910,1177894780,1178431651,1178968522,1179505393,1180042264,1180579135,    // 2190 --> 2199
1181116006,1181652877,1182189748,1182726619,1183263490,1183800360,1184337231,1184874102,1185410973,1185947844,    // 2200 --> 2209
1186484715,1187021586,1187558457,1188095328,1188632199,1189169070,1189705940,1190242811,1190779682,1191316553,    // 2210 --> 2219
1191853424,1192390295,1192927166,1193464037,1194000908,1194537779,1195074650,1195611521,1196148391,1196685262,    // 2220 --> 2229
1197222133,1197759004,1198295875,1198832746,1199369617,1199906488,1200443359,1200980230,1201517101,1202053971,    // 2230 --> 2239
1202590842,1203127713,1203664584,1204201455,1204738326,1205275197,1205812068,1206348939,1206885810,1207422681,    // 2240 --> 2249
1207959552,1208496422,1209033293,1209570164,1210107035,1210643906,1211180777,1211717648,1212254519,1212791390,    // 2250 --> 2259
1213328261,1213865132,1214402002,1214938873,1215475744,1216012615,1216549486,1217086357,1217623228,1218160099,    // 2260 --> 2269
1218696970,1219233841,1219770712,1220307582,1220844453,1221381324,1221918195,1222455066,1222991937,1223528808,    // 2270 --> 2279
1224065679,1224602550,1225139421,1225676292,1226213163,1226750033,1227286904,1227823775,1228360646,1228897517,    // 2280 --> 2289
1229434388,1229971259,1230508130,1231045001,1231581872,1232118743,1232655613,1233192484,1233729355,1234266226,    // 2290 --> 2299
1234803097,1235339968,1235876839,1236413710,1236950581,1237487452,1238024323,1238561193,1239098064,1239634935,    // 2300 --> 2309
1240171806,1240708677,1241245548,1241782419,1242319290,1242856161,1243393032,1243929903,1244466774,1245003644,    // 2310 --> 2319
1245540515,1246077386,1246614257,1247151128,1247687999,1248224870,1248761741,1249298612,1249835483,1250372354,    // 2320 --> 2329
1250909224,1251446095,1251982966,1252519837,1253056708,1253593579,1254130450,1254667321,1255204192,1255741063,    // 2330 --> 2339
1256277934,1256814804,1257351675,1257888546,1258425417,1258962288,1259499159,1260036030,1260572901,1261109772,    // 2340 --> 2349
1261646643,1262183514,1262720385,1263257255,1263794126,1264330997,1264867868,1265404739,1265941610,1266478481,    // 2350 --> 2359
1267015352,1267552223,1268089094,1268625965,1269162835,1269699706,1270236577,1270773448,1271310319,1271847190,    // 2360 --> 2369
1272384061,1272920932,1273457803,1273994674,1274531545,1275068416,1275605286,1276142157,1276679028,1277215899,    // 2370 --> 2379
1277752770,1278289641,1278826512,1279363383,1279900254,1280437125,1280973996,1281510866,1282047737,1282584608,    // 2380 --> 2389
1283121479,1283658350,1284195221,1284732092,1285268963,1285805834,1286342705,1286879576,1287416446,1287953317,    // 2390 --> 2399
1288490188,1289027059,1289563930,1290100801,1290637672,1291174543,1291711414,1292248285,1292785156,1293322027,    // 2400 --> 2409
1293858897,1294395768,1294932639,1295469510,1296006381,1296543252,1297080123,1297616994,1298153865,1298690736,    // 2410 --> 2419
1299227607,1299764477,1300301348,1300838219,1301375090,1301911961,1302448832,1302985703,1303522574,1304059445,    // 2420 --> 2429
1304596316,1305133187,1305670057,1306206928,1306743799,1307280670,1307817541,1308354412,1308891283,1309428154,    // 2430 --> 2439
1309965025,1310501896,1311038767,1311575638,1312112508,1312649379,1313186250,1313723121,1314259992,1314796863,    // 2440 --> 2449
1315333734,1315870605,1316407476,1316944347,1317481218,1318018088,1318554959,1319091830,1319628701,1320165572,    // 2450 --> 2459
1320702443,1321239314,1321776185,1322313056,1322849927,1323386798,1323923668,1324460539,1324997410,1325534281,    // 2460 --> 2469
1326071152,1326608023,1327144894,1327681765,1328218636,1328755507,1329292378,1329829249,1330366119,1330902990,    // 2470 --> 2479
1331439861,1331976732,1332513603,1333050474,1333587345,1334124216,1334661087,1335197958,1335734829,1336271699,    // 2480 --> 2489
1336808570,1337345441,1337882312,1338419183,1338956054,1339492925,1340029796,1340566667,1341103538,1341640409,    // 2490 --> 2499
1342177280,1342714150,1343251021,1343787892,1344324763,1344861634,1345398505,1345935376,1346472247,1347009118,    // 2500 --> 2509
1347545989,1348082860,1348619730,1349156601,1349693472,1350230343,1350767214,1351304085,1351840956,1352377827,    // 2510 --> 2519
1352914698,1353451569,1353988440,1354525310,1355062181,1355599052,1356135923,1356672794,1357209665,1357746536,    // 2520 --> 2529
1358283407,1358820278,1359357149,1359894020,1360430891,1360967761,1361504632,1362041503,1362578374,1363115245,    // 2530 --> 2539
1363652116,1364188987,1364725858,1365262729,1365799600,1366336471,1366873341,1367410212,1367947083,1368483954,    // 2540 --> 2549
1369020825,1369557696,1370094567,1370631438,1371168309,1371705180,1372242051,1372778921,1373315792,1373852663,    // 2550 --> 2559
1374389534,1374926405,1375463276,1376000147,1376537018,1377073889,1377610760,1378147631,1378684502,1379221372,    // 2560 --> 2569
1379758243,1380295114,1380831985,1381368856,1381905727,1382442598,1382979469,1383516340,1384053211,1384590082,    // 2570 --> 2579
1385126952,1385663823,1386200694,1386737565,1387274436,1387811307,1388348178,1388885049,1389421920,1389958791,    // 2580 --> 2589
1390495662,1391032532,1391569403,1392106274,1392643145,1393180016,1393716887,1394253758,1394790629,1395327500,    // 2590 --> 2599
1395864371,1396401242,1396938113,1397474983,1398011854,1398548725,1399085596,1399622467,1400159338,1400696209,    // 2600 --> 2609
1401233080,1401769951,1402306822,1402843693,1403380563,1403917434,1404454305,1404991176,1405528047,1406064918,    // 2610 --> 2619
1406601789,1407138660,1407675531,1408212402,1408749273,1409286144,1409823014,1410359885,1410896756,1411433627,    // 2620 --> 2629
1411970498,1412507369,1413044240,1413581111,1414117982,1414654853,1415191724,1415728594,1416265465,1416802336,    // 2630 --> 2639
1417339207,1417876078,1418412949,1418949820,1419486691,1420023562,1420560433,1421097304,1421634174,1422171045,    // 2640 --> 2649
1422707916,1423244787,1423781658,1424318529,1424855400,1425392271,1425929142,1426466013,1427002884,1427539755,    // 2650 --> 2659
1428076625,1428613496,1429150367,1429687238,1430224109,1430760980,1431297851,1431834722,1432371593,1432908464,    // 2660 --> 2669
1433445335,1433982205,1434519076,1435055947,1435592818,1436129689,1436666560,1437203431,1437740302,1438277173,    // 2670 --> 2679
1438814044,1439350915,1439887785,1440424656,1440961527,1441498398,1442035269,1442572140,1443109011,1443645882,    // 2680 --> 2689
1444182753,1444719624,1445256495,1445793366,1446330236,1446867107,1447403978,1447940849,1448477720,1449014591,    // 2690 --> 2699
1449551462,1450088333,1450625204,1451162075,1451698946,1452235816,1452772687,1453309558,1453846429,1454383300,    // 2700 --> 2709
1454920171,1455457042,1455993913,1456530784,1457067655,1457604526,1458141396,1458678267,1459215138,1459752009,    // 2710 --> 2719
1460288880,1460825751,1461362622,1461899493,1462436364,1462973235,1463510106,1464046977,1464583847,1465120718,    // 2720 --> 2729
1465657589,1466194460,1466731331,1467268202,1467805073,1468341944,1468878815,1469415686,1469952557,1470489427,    // 2730 --> 2739
1471026298,1471563169,1472100040,1472636911,1473173782,1473710653,1474247524,1474784395,1475321266,1475858137,    // 2740 --> 2749
1476395008,1476931878,1477468749,1478005620,1478542491,1479079362,1479616233,1480153104,1480689975,1481226846,    // 2750 --> 2759
1481763717,1482300588,1482837458,1483374329,1483911200,1484448071,1484984942,1485521813,1486058684,1486595555,    // 2760 --> 2769
1487132426,1487669297,1488206168,1488743038,1489279909,1489816780,1490353651,1490890522,1491427393,1491964264,    // 2770 --> 2779
1492501135,1493038006,1493574877,1494111748,1494648619,1495185489,1495722360,1496259231,1496796102,1497332973,    // 2780 --> 2789
1497869844,1498406715,1498943586,1499480457,1500017328,1500554199,1501091069,1501627940,1502164811,1502701682,    // 2790 --> 2799
1503238553,1503775424,1504312295,1504849166,1505386037,1505922908,1506459779,1506996649,1507533520,1508070391,    // 2800 --> 2809
1508607262,1509144133,1509681004,1510217875,1510754746,1511291617,1511828488,1512365359,1512902230,1513439100,    // 2810 --> 2819
1513975971,1514512842,1515049713,1515586584,1516123455,1516660326,1517197197,1517734068,1518270939,1518807810,    // 2820 --> 2829
1519344680,1519881551,1520418422,1520955293,1521492164,1522029035,1522565906,1523102777,1523639648,1524176519,    // 2830 --> 2839
1524713390,1525250260,1525787131,1526324002,1526860873,1527397744,1527934615,1528471486,1529008357,1529545228,    // 2840 --> 2849
1530082099,1530618970,1531155841,1531692711,1532229582,1532766453,1533303324,1533840195,1534377066,1534913937,    // 2850 --> 2859
1535450808,1535987679,1536524550,1537061421,1537598291,1538135162,1538672033,1539208904,1539745775,1540282646,    // 2860 --> 2869
1540819517,1541356388,1541893259,1542430130,1542967001,1543503872,1544040742,1544577613,1545114484,1545651355,    // 2870 --> 2879
1546188226,1546725097,1547261968,1547798839,1548335710,1548872581,1549409452,1549946322,1550483193,1551020064,    // 2880 --> 2889
1551556935,1552093806,1552630677,1553167548,1553704419,1554241290,1554778161,1555315032,1555851902,1556388773,    // 2890 --> 2899
1556925644,1557462515,1557999386,1558536257,1559073128,1559609999,1560146870,1560683741,1561220612,1561757483,    // 2900 --> 2909
1562294353,1562831224,1563368095,1563904966,1564441837,1564978708,1565515579,1566052450,1566589321,1567126192,    // 2910 --> 2919
1567663063,1568199933,1568736804,1569273675,1569810546,1570347417,1570884288,1571421159,1571958030,1572494901,    // 2920 --> 2929
1573031772,1573568643,1574105513,1574642384,1575179255,1575716126,1576252997,1576789868,1577326739,1577863610,    // 2930 --> 2939
1578400481,1578937352,1579474223,1580011094,1580547964,1581084835,1581621706,1582158577,1582695448,1583232319,    // 2940 --> 2949
1583769190,1584306061,1584842932,1585379803,1585916674,1586453544,1586990415,1587527286,1588064157,1588601028,    // 2950 --> 2959
1589137899,1589674770,1590211641,1590748512,1591285383,1591822254,1592359124,1592895995,1593432866,1593969737,    // 2960 --> 2969
1594506608,1595043479,1595580350,1596117221,1596654092,1597190963,1597727834,1598264705,1598801575,1599338446,    // 2970 --> 2979
1599875317,1600412188,1600949059,1601485930,1602022801,1602559672,1603096543,1603633414,1604170285,1604707155,    // 2980 --> 2989
1605244026,1605780897,1606317768,1606854639,1607391510,1607928381,1608465252,1609002123,1609538994,1610075865,    // 2990 --> 2999
1610612736,1611149606,1611686477,1612223348,1612760219,1613297090,1613833961,1614370832,1614907703,1615444574,    // 3000 --> 3009
1615981445,1616518316,1617055186,1617592057,1618128928,1618665799,1619202670,1619739541,1620276412,1620813283,    // 3010 --> 3019
1621350154,1621887025,1622423896,1622960766,1623497637,1624034508,1624571379,1625108250,1625645121,1626181992,    // 3020 --> 3029
1626718863,1627255734,1627792605,1628329476,1628866347,1629403217,1629940088,1630476959,1631013830,1631550701,    // 3030 --> 3039
1632087572,1632624443,1633161314,1633698185,1634235056,1634771927,1635308797,1635845668,1636382539,1636919410,    // 3040 --> 3049
1637456281,1637993152,1638530023,1639066894,1639603765,1640140636,1640677507,1641214377,1641751248,1642288119,    // 3050 --> 3059
1642824990,1643361861,1643898732,1644435603,1644972474,1645509345,1646046216,1646583087,1647119958,1647656828,    // 3060 --> 3069
1648193699,1648730570,1649267441,1649804312,1650341183,1650878054,1651414925,1651951796,1652488667,1653025538,    // 3070 --> 3079
1653562408,1654099279,1654636150,1655173021,1655709892,1656246763,1656783634,1657320505,1657857376,1658394247,    // 3080 --> 3089
1658931118,1659467988,1660004859,1660541730,1661078601,1661615472,1662152343,1662689214,1663226085,1663762956,    // 3090 --> 3099
1664299827,1664836698,1665373569,1665910439,1666447310,1666984181,1667521052,1668057923,1668594794,1669131665,    // 3100 --> 3109
1669668536,1670205407,1670742278,1671279149,1671816019,1672352890,1672889761,1673426632,1673963503,1674500374,    // 3110 --> 3119
1675037245,1675574116,1676110987,1676647858,1677184729,1677721600,1678258470,1678795341,1679332212,1679869083,    // 3120 --> 3129
1680405954,1680942825,1681479696,1682016567,1682553438,1683090309,1683627180,1684164050,1684700921,1685237792,    // 3130 --> 3139
1685774663,1686311534,1686848405,1687385276,1687922147,1688459018,1688995889,1689532760,1690069630,1690606501,    // 3140 --> 3149
1691143372,1691680243,1692217114,1692753985,1693290856,1693827727,1694364598,1694901469,1695438340,1695975211,    // 3150 --> 3159
1696512081,1697048952,1697585823,1698122694,1698659565,1699196436,1699733307,1700270178,1700807049,1701343920,    // 3160 --> 3169
1701880791,1702417661,1702954532,1703491403,1704028274,1704565145,1705102016,1705638887,1706175758,1706712629,    // 3170 --> 3179
1707249500,1707786371,1708323241,1708860112,1709396983,1709933854,1710470725,1711007596,1711544467,1712081338,    // 3180 --> 3189
1712618209,1713155080,1713691951,1714228822,1714765692,1715302563,1715839434,1716376305,1716913176,1717450047,    // 3190 --> 3199
1717986918,1718523789,1719060660,1719597531,1720134402,1720671272,1721208143,1721745014,1722281885,1722818756,    // 3200 --> 3209
1723355627,1723892498,1724429369,1724966240,1725503111,1726039982,1726576852,1727113723,1727650594,1728187465,    // 3210 --> 3219
1728724336,1729261207,1729798078,1730334949,1730871820,1731408691,1731945562,1732482433,1733019303,1733556174,    // 3220 --> 3229
1734093045,1734629916,1735166787,1735703658,1736240529,1736777400,1737314271,1737851142,1738388013,1738924883,    // 3230 --> 3239
1739461754,1739998625,1740535496,1741072367,1741609238,1742146109,1742682980,1743219851,1743756722,1744293593,    // 3240 --> 3249
1744830464,1745367334,1745904205,1746441076,1746977947,1747514818,1748051689,1748588560,1749125431,1749662302,    // 3250 --> 3259
1750199173,1750736044,1751272914,1751809785,1752346656,1752883527,1753420398,1753957269,1754494140,1755031011,    // 3260 --> 3269
1755567882,1756104753,1756641624,1757178494,1757715365,1758252236,1758789107,1759325978,1759862849,1760399720,    // 3270 --> 3279
1760936591,1761473462,1762010333,1762547204,1763084075,1763620945,1764157816,1764694687,1765231558,1765768429,    // 3280 --> 3289
1766305300,1766842171,1767379042,1767915913,1768452784,1768989655,1769526525,1770063396,1770600267,1771137138,    // 3290 --> 3299
1771674009,1772210880,1772747751,1773284622,1773821493,1774358364,1774895235,1775432105,1775968976,1776505847,    // 3300 --> 3309
1777042718,1777579589,1778116460,1778653331,1779190202,1779727073,1780263944,1780800815,1781337686,1781874556,    // 3310 --> 3319
1782411427,1782948298,1783485169,1784022040,1784558911,1785095782,1785632653,1786169524,1786706395,1787243266,    // 3320 --> 3329
1787780136,1788317007,1788853878,1789390749,1789927620,1790464491,1791001362,1791538233,1792075104,1792611975,    // 3330 --> 3339
1793148846,1793685716,1794222587,1794759458,1795296329,1795833200,1796370071,1796906942,1797443813,1797980684,    // 3340 --> 3349
1798517555,1799054426,1799591297,1800128167,1800665038,1801201909,1801738780,1802275651,1802812522,1803349393,    // 3350 --> 3359
1803886264,1804423135,1804960006,1805496877,1806033747,1806570618,1807107489,1807644360,1808181231,1808718102,    // 3360 --> 3369
1809254973,1809791844,1810328715,1810865586,1811402457,1811939328,1812476198,1813013069,1813549940,1814086811,    // 3370 --> 3379
1814623682,1815160553,1815697424,1816234295,1816771166,1817308037,1817844908,1818381778,1818918649,1819455520,    // 3380 --> 3389
1819992391,1820529262,1821066133,1821603004,1822139875,1822676746,1823213617,1823750488,1824287358,1824824229,    // 3390 --> 3399
1825361100,1825897971,1826434842,1826971713,1827508584,1828045455,1828582326,1829119197,1829656068,1830192939,    // 3400 --> 3409
1830729809,1831266680,1831803551,1832340422,1832877293,1833414164,1833951035,1834487906,1835024777,1835561648,    // 3410 --> 3419
1836098519,1836635389,1837172260,1837709131,1838246002,1838782873,1839319744,1839856615,1840393486,1840930357,    // 3420 --> 3429
1841467228,1842004099,1842540969,1843077840,1843614711,1844151582,1844688453,1845225324,1845762195,1846299066,    // 3430 --> 3439
1846835937,1847372808,1847909679,1848446550,1848983420,1849520291,1850057162,1850594033,1851130904,1851667775,    // 3440 --> 3449
1852204646,1852741517,1853278388,1853815259,1854352130,1854889000,1855425871,1855962742,1856499613,1857036484,    // 3450 --> 3459
1857573355,1858110226,1858647097,1859183968,1859720839,1860257710,1860794580,1861331451,1861868322,1862405193,    // 3460 --> 3469
1862942064,1863478935,1864015806,1864552677,1865089548,1865626419,1866163290,1866700161,1867237031,1867773902,    // 3470 --> 3479
1868310773,1868847644,1869384515,1869921386,1870458257,1870995128,1871531999,1872068870,1872605741,1873142611,    // 3480 --> 3489
1873679482,1874216353,1874753224,1875290095,1875826966,1876363837,1876900708,1877437579,1877974450,1878511321,    // 3490 --> 3499
1879048192,1879585062,1880121933,1880658804,1881195675,1881732546,1882269417,1882806288,1883343159,1883880030,    // 3500 --> 3509
1884416901,1884953772,1885490642,1886027513,1886564384,1887101255,1887638126,1888174997,1888711868,1889248739,    // 3510 --> 3519
1889785610,1890322481,1890859352,1891396222,1891933093,1892469964,1893006835,1893543706,1894080577,1894617448,    // 3520 --> 3529
1895154319,1895691190,1896228061,1896764932,1897301803,1897838673,1898375544,1898912415,1899449286,1899986157,    // 3530 --> 3539
1900523028,1901059899,1901596770,1902133641,1902670512,1903207383,1903744253,1904281124,1904817995,1905354866,    // 3540 --> 3549
1905891737,1906428608,1906965479,1907502350,1908039221,1908576092,1909112963,1909649833,1910186704,1910723575,    // 3550 --> 3559
1911260446,1911797317,1912334188,1912871059,1913407930,1913944801,1914481672,1915018543,1915555414,1916092284,    // 3560 --> 3569
1916629155,1917166026,1917702897,1918239768,1918776639,1919313510,1919850381,1920387252,1920924123,1921460994,    // 3570 --> 3579
1921997864,1922534735,1923071606,1923608477,1924145348,1924682219,1925219090,1925755961,1926292832,1926829703,    // 3580 --> 3589
1927366574,1927903444,1928440315,1928977186,1929514057,1930050928,1930587799,1931124670,1931661541,1932198412,    // 3590 --> 3599
1932735283,1933272154,1933809025,1934345895,1934882766,1935419637,1935956508,1936493379,1937030250,1937567121,    // 3600 --> 3609
1938103992,1938640863,1939177734,1939714605,1940251475,1940788346,1941325217,1941862088,1942398959,1942935830,    // 3610 --> 3619
1943472701,1944009572,1944546443,1945083314,1945620185,1946157056,1946693926,1947230797,1947767668,1948304539,    // 3620 --> 3629
1948841410,1949378281,1949915152,1950452023,1950988894,1951525765,1952062636,1952599506,1953136377,1953673248,    // 3630 --> 3639
1954210119,1954746990,1955283861,1955820732,1956357603,1956894474,1957431345,1957968216,1958505086,1959041957,    // 3640 --> 3649
1959578828,1960115699,1960652570,1961189441,1961726312,1962263183,1962800054,1963336925,1963873796,1964410667,    // 3650 --> 3659
1964947537,1965484408,1966021279,1966558150,1967095021,1967631892,1968168763,1968705634,1969242505,1969779376,    // 3660 --> 3669
1970316247,1970853117,1971389988,1971926859,1972463730,1973000601,1973537472,1974074343,1974611214,1975148085,    // 3670 --> 3679
1975684956,1976221827,1976758697,1977295568,1977832439,1978369310,1978906181,1979443052,1979979923,1980516794,    // 3680 --> 3689
1981053665,1981590536,1982127407,1982664278,1983201148,1983738019,1984274890,1984811761,1985348632,1985885503,    // 3690 --> 3699
1986422374,1986959245,1987496116,1988032987,1988569858,1989106728,1989643599,1990180470,1990717341,1991254212,    // 3700 --> 3709
1991791083,1992327954,1992864825,1993401696,1993938567,1994475438,1995012308,1995549179,1996086050,1996622921,    // 3710 --> 3719
1997159792,1997696663,1998233534,1998770405,1999307276,1999844147,2000381018,2000917889,2001454759,2001991630,    // 3720 --> 3729
2002528501,2003065372,2003602243,2004139114,2004675985,2005212856,2005749727,2006286598,2006823469,2007360339,    // 3730 --> 3739
2007897210,2008434081,2008970952,2009507823,2010044694,2010581565,2011118436,2011655307,2012192178,2012729049,    // 3740 --> 3749
2013265920,2013802790,2014339661,2014876532,2015413403,2015950274,2016487145,2017024016,2017560887,2018097758,    // 3750 --> 3759
2018634629,2019171500,2019708370,2020245241,2020782112,2021318983,2021855854,2022392725,2022929596,2023466467,    // 3760 --> 3769
2024003338,2024540209,2025077080,2025613950,2026150821,2026687692,2027224563,2027761434,2028298305,2028835176,    // 3770 --> 3779
2029372047,2029908918,2030445789,2030982660,2031519531,2032056401,2032593272,2033130143,2033667014,2034203885,    // 3780 --> 3789
2034740756,2035277627,2035814498,2036351369,2036888240,2037425111,2037961981,2038498852,2039035723,2039572594,    // 3790 --> 3799
2040109465,2040646336,2041183207,2041720078,2042256949,2042793820,2043330691,2043867561,2044404432,2044941303,    // 3800 --> 3809
2045478174,2046015045,2046551916,2047088787,2047625658,2048162529,2048699400,2049236271,2049773142,2050310012,    // 3810 --> 3819
2050846883,2051383754,2051920625,2052457496,2052994367,2053531238,2054068109,2054604980,2055141851,2055678722,    // 3820 --> 3829
2056215592,2056752463,2057289334,2057826205,2058363076,2058899947,2059436818,2059973689,2060510560,2061047431,    // 3830 --> 3839
2061584302,2062121172,2062658043,2063194914,2063731785,2064268656,2064805527,2065342398,2065879269,2066416140,    // 3840 --> 3849
2066953011,2067489882,2068026753,2068563623,2069100494,2069637365,2070174236,2070711107,2071247978,2071784849,    // 3850 --> 3859
2072321720,2072858591,2073395462,2073932333,2074469203,2075006074,2075542945,2076079816,2076616687,2077153558,    // 3860 --> 3869
2077690429,2078227300,2078764171,2079301042,2079837913,2080374784,2080911654,2081448525,2081985396,2082522267,    // 3870 --> 3879
2083059138,2083596009,2084132880,2084669751,2085206622,2085743493,2086280364,2086817234,2087354105,2087890976,    // 3880 --> 3889
2088427847,2088964718,2089501589,2090038460,2090575331,2091112202,2091649073,2092185944,2092722814,2093259685,    // 3890 --> 3899
2093796556,2094333427,2094870298,2095407169,2095944040,2096480911,2097017782,2097554653,2098091524,2098628395,    // 3900 --> 3909
2099165265,2099702136,2100239007,2100775878,2101312749,2101849620,2102386491,2102923362,2103460233,2103997104,    // 3910 --> 3919
2104533975,2105070845,2105607716,2106144587,2106681458,2107218329,2107755200,2108292071,2108828942,2109365813,    // 3920 --> 3929
2109902684,2110439555,2110976425,2111513296,2112050167,2112587038,2113123909,2113660780,2114197651,2114734522,    // 3930 --> 3939
2115271393,2115808264,2116345135,2116882006,2117418876,2117955747,2118492618,2119029489,2119566360,2120103231,    // 3940 --> 3949
2120640102,2121176973,2121713844,2122250715,2122787586,2123324456,2123861327,2124398198,2124935069,2125471940,    // 3950 --> 3959
2126008811,2126545682,2127082553,2127619424,2128156295,2128693166,2129230036,2129766907,2130303778,2130840649,    // 3960 --> 3969
2131377520,2131914391,2132451262,2132988133,2133525004,2134061875,2134598746,2135135617,2135672487,2136209358,    // 3970 --> 3979
2136746229,2137283100,2137819971,2138356842,2138893713,2139430584,2139967455,2140504326,2141041197,2141578067,    // 3980 --> 3989
2142114938,2142651809,2143188680,2143725551,2144262422,2144799293,2145336164,2145873035,2146409906,2146946777     // 3990 --> 3999
};

#if 0
static void gen_power_tbl()
{
    int i = 0;
    int nlast = 0;
    int n = 0;
    float f = 0.0f;
    for (i = 0; i < FSK_MIN_LEVEL_COUNT; i ++)
    {
        printf("%9d,", power_meter_level_dbm0(i + 2.5f - 6.04f));
        if ((i + 1) % 10 == 0)
        {
            printf("    // %3d --> %3d\n", nlast, i);
            nlast = i + 1;
        }
    }

    printf("\n\n");

    nlast = 0;
    for (i = 0; i < FSK_MIN_LEVEL_COUNT; i ++)
    {
        printf("%9d,", power_meter_level_dbm0(i - 2.5f - 6.04f));
        if ((i + 1) % 10 == 0)
        {
            printf("    // %3d --> %3d\n", nlast, i);
            nlast = i + 1;
        }
    }

    printf("\n\n");

    nlast = 0;
    for (i = 0; i < (SAMPLE_RATE / 2 + 1); i  ++)
    {
        f = i;
        n = dds_phase_rate(3.0f);
        printf("%9d,", n);
        if ((i + 1) % 10 == 0)
        {
            printf("    // %3d --> %3d\n", nlast, i);
            nlast = i + 1;
        }
    }
    printf("\n\n");
}

#endif
static void fsk_rx_signal_cutoff(fsk_rx_state_t *s, int32_t cutoff)
{
    /* The 6.04 allows for the gain of the DC blocker */
#ifdef SPANDSP_USE_FIXED_POINT
    s->carrier_on_power = FSK_ON_POWER_TBL[-cutoff];
    s->carrier_off_power = FSK_OFF_POWER_TBL[-cutoff];
#else
    s->carrier_on_power = (int32_t) (power_meter_level_dbm0(cutoff + 2.5f - 6.04f));
    s->carrier_off_power = (int32_t) (power_meter_level_dbm0(cutoff - 2.5f - 6.04f));
#endif
}


static power_meter_t * power_meter_init(power_meter_t *s, int shift)
{
    if (s == NULL)
    {
        if ((s = (power_meter_t *) malloc(sizeof(*s))) == ((void *)0))
            return NULL;
    }
    s->shift = shift;
    s->reading = 0;
    return s;
}

#ifndef SPANDSP_USE_FIXED_POINT
int32_t dds_phase_rate(float frequency)
{
    return (int32_t) (frequency*65536.0f*65536.0f/SAMPLE_RATE);
}
#endif

static int fsk_rx_restart(fsk_rx_state_t *s, const fsk_spec_t *spec, int framing_mode)
{
    int chop;

    s->baud_rate = spec->baud_rate;
    s->framing_mode = framing_mode;
    fsk_rx_signal_cutoff(s, spec->min_level);

    /* Detect by correlating against the tones we want, over a period
       of one baud. The correlation must be quadrature. */

    /* First we need the quadrature tone generators to correlate
       against. */
#ifdef SPANDSP_USE_FIXED_POINT
    s->phase_rate[0] = FSK_DDS_PHASE_RATE[spec->freq_zero];//dds_phase_rate((float) spec->freq_zero);
    s->phase_rate[1] = FSK_DDS_PHASE_RATE[spec->freq_one];//dds_phase_rate((float) spec->freq_one);
#else
    s->phase_rate[0] = dds_phase_rate((float) spec->freq_zero);
    s->phase_rate[1] = dds_phase_rate((float) spec->freq_one);
#endif
    s->phase_acc[0] = 0;
    s->phase_acc[1] = 0;
    s->last_sample = 0;

    /* The correlation should be over one baud. */
    s->correlation_span = SAMPLE_RATE*100/spec->baud_rate;
    /* But limit it for very slow baud rates, so we do not overflow our
       buffer. */
    if (s->correlation_span > FSK_MAX_WINDOW_LEN)
        s->correlation_span = FSK_MAX_WINDOW_LEN;
    /*endif*/

    /* We need to scale, to avoid overflow in the correlation. */
    s->scaling_shift = 0;
    chop = s->correlation_span;
    while (chop != 0)
    {
        s->scaling_shift++;
        chop >>= 1;
    }
    /*endwhile*/

    /* Initialise the baud/bit rate tracking. */
    s->baud_phase = 0;
    s->frame_state = 0;
    s->frame_bits = 0;
    s->last_bit = 0;

    s->fsk_count = 0;
    s->fsk_count_old = 0;
    s->fskcurintcnt = 0;
    s->fskintcnt0 = 0;

    memset(s->fsks,0,sizeof(s->fsks));

    /* Initialise a power detector, so sense when a signal is present. */
    power_meter_init(&s->power, 4);
    s->signal_present = 0;
    return 0;
}


static fsk_rx_state_t * fsk_rx_init(fsk_rx_state_t *s,
                             const fsk_spec_t *spec,
                             int framing_mode,
                             fsk_report_func_t put_bit,
                             void *user_data)
{
    if (s == NULL)
    {
        if ((s = (fsk_rx_state_t *) malloc(sizeof(*s))) == ((void *)0))
            return NULL;
        /*endif*/
    }
    /*endif*/
    memset(s, 0, sizeof(*s));

    s->put_bit = put_bit;
    s->put_bit_user_data = user_data;
    fsk_rx_restart(s, spec, framing_mode);
    return s;
}

static complexi_t complex_seti(int re, int im)
{
    complexi_t z;

    z.re = re;
    z.im = im;
    return z;
}


static int16_t dds_lookup(uint32_t phase)
{
    uint32_t step;
    int16_t amp;

    phase >>= DDS_SHIFT;
    step = phase & (DDS_STEPS - 1);
    if ((phase & DDS_STEPS))
        step = DDS_STEPS - step;
    amp = sine_table[step];
    if ((phase & (2*DDS_STEPS)))
        amp = -amp;
    return amp;
}


static complexi_t dds_complexi(uint32_t *phase_acc, int32_t phase_rate)
{
    complexi_t amp;

    amp = complex_seti(dds_lookup(*phase_acc + (1 << 30)), dds_lookup(*phase_acc));
    *phase_acc += phase_rate;
    return amp;
}


static int32_t power_meter_update(power_meter_t *s, int16_t amp)
{
    s->reading += ((amp*amp - s->reading) >> s->shift);
    return s->reading;
}


static void report_status_change(fsk_rx_state_t *s, int status)
{
    if (s->status_handler)
        s->status_handler(s->status_user_data, status);
    else if (s->put_bit)
        s->put_bit(s->put_bit_user_data, status);
    /*endif*/
}

static int fsk_rx(fsk_rx_state_t *s, const int16_t *amp, int len)
{
    int buf_ptr;
    int baudstate;
    int i;
    int j;
    int16_t x;
    int32_t dot;
    int32_t sum[2];
    int32_t power;
    complexi_t ph;

    buf_ptr = s->buf_ptr;
    for (i = 0;  i < len;  i++)
    {
        /* The *totally* asynchronous character to character behaviour of these
           modems, when carrying async. data, seems to force a sample by sample
           approach. */
        for (j = 0;  j < 2;  j++)
        {
            s->dot[j].re -= s->window[j][buf_ptr].re;
            s->dot[j].im -= s->window[j][buf_ptr].im;

            ph = dds_complexi(&s->phase_acc[j], s->phase_rate[j]);
            s->window[j][buf_ptr].re = (ph.re*amp[i]) >> s->scaling_shift;
            s->window[j][buf_ptr].im = (ph.im*amp[i]) >> s->scaling_shift;

            s->dot[j].re += s->window[j][buf_ptr].re;
            s->dot[j].im += s->window[j][buf_ptr].im;

            dot = s->dot[j].re >> 15;
            sum[j] = dot*dot;
            dot = s->dot[j].im >> 15;
            sum[j] += dot*dot;
        }
        /*endfor*/
        /* If there isn't much signal, don't demodulate - it will only produce
           useless junk results. */
        /* There should be no DC in the signal, but sometimes there is.
           We need to measure the power with the DC blocked, but not using
           a slow to respond DC blocker. Use the most elementary HPF. */
        x = amp[i] >> 1;
        power = power_meter_update(&s->power, x - s->last_sample);
        s->last_sample = x;
        if (s->signal_present)
        {
            /* Look for power below turn-off threshold to turn the carrier off */
            if (power < s->carrier_off_power)
            {
                if (--s->signal_present <= 0)
                {
                    /* Count down a short delay, to ensure we push the last
                       few bits through the filters before stopping. */
                    report_status_change(s, SIG_STATUS_CARRIER_DOWN);
                    s->baud_phase = 0;
                    continue;
                }
                /*endif*/
            }
            /*endif*/
        }
        else
        {
            /* Look for power exceeding turn-on threshold to turn the carrier on */
            if (power < s->carrier_on_power)
            {
                s->baud_phase = 0;
                continue;
            }
            /*endif*/
            if (s->baud_phase < (s->correlation_span >> 1) - 30)
            {
                s->baud_phase++;
                continue;
            }
            /*endif*/
            s->signal_present = 1;
            /* Initialise the baud/bit rate tracking. */
            s->baud_phase = 0;
            s->frame_state = 0;
            s->frame_bits = 0;
            s->last_bit = (sum[0] < sum[1]);	//0
            report_status_change(s, SIG_STATUS_CARRIER_UP);
        }
        /*endif*/
        /* Non-coherent FSK demodulation by correlation with the target tones
           over a one baud interval. The slow V.xx specs. are too open ended
           to allow anything fancier to be used. The dot products are calculated
           using a sliding window approach, so the compute load is not that great. */

        baudstate = (sum[0] < sum[1]);
        switch (s->framing_mode)
        {
        case FSK_FRAME_MODE_SYNC:
            /* Synchronous serial operation - e.g. for HDLC */
            if (s->last_bit != baudstate)
            {
                /* On a transition we check our timing */
                s->last_bit = baudstate;
                /* For synchronous use (e.g. HDLC channels in FAX modems), nudge
                   the baud phase gently, trying to keep it centred on the bauds. */
                if (s->baud_phase < (SAMPLE_RATE*50))
                    s->baud_phase += (s->baud_rate >> 3);
                else
                    s->baud_phase -= (s->baud_rate >> 3);
                /*endif*/
            }
            /*endif*/
            if ((s->baud_phase += s->baud_rate) >= (SAMPLE_RATE*100))
            {
                /* We should be in the middle of a baud now, so report the current
                   state as the next bit */
                s->baud_phase -= (SAMPLE_RATE*100);
                s->put_bit(s->put_bit_user_data, baudstate);
            }
            /*endif*/
            break;
        case FSK_FRAME_MODE_ASYNC:
            /* Fully asynchronous mode */
            if (s->last_bit != baudstate)
            {
                /* On a transition we check our timing */
                s->last_bit = baudstate;
                /* For async. operation, believe transitions completely, and
                   sample appropriately. This allows instant start on the first
                   transition. */
                /* We must now be about half way to a sampling point. We do not do
                   any fractional sample estimation of the transitions, so this is
                   the most accurate baud alignment we can do. */
                s->baud_phase = SAMPLE_RATE*50;
            }
            /*endif*/
            if ((s->baud_phase += s->baud_rate) >= (SAMPLE_RATE*100))
            {
                /* We should be in the middle of a baud now, so report the current
                   state as the next bit */
                s->baud_phase -= (SAMPLE_RATE*100);
                s->put_bit(s->put_bit_user_data, baudstate);
            }
            /*endif*/
            break;
        case FSK_FRAME_MODE_5N1_FRAMES:
        case FSK_FRAME_MODE_7N1_FRAMES:
        case FSK_FRAME_MODE_7E1_FRAMES:
        case FSK_FRAME_MODE_7E2_FRAMES:
        default:
            /* Gather the specified number of bits, with robust checking to ensure reasonable voice immunity.
               The first bit should be a start bit (0), and the last bit should be a stop bit (1) */
            if (s->frame_state == 0)
            {
                /* Looking for the start of a zero bit, which hopefully the start of a start bit */
                if (baudstate == 0)
                {
                    s->baud_phase = SAMPLE_RATE*(100 - 40)/2;
                    s->frame_state = -1;
                    s->frame_bits = 0;
                    s->last_bit = -1;
                }
                /*endif*/
            }
            else if (s->frame_state == -1)
            {
                /* Look for a continuous zero from the start of the start bit until
                   beyond the middle */
                if (baudstate != 0)
                {
                    /* If we aren't looking at a stable start bit, restart */
                    s->frame_state = 0;
                }
                else
                {
                    s->baud_phase += s->baud_rate;
                    if (s->baud_phase >= SAMPLE_RATE*100)
                    {
                        s->frame_state = 1;
                        s->last_bit = baudstate;
                    }
                    /*endif*/
                }
                /*endif*/
            }
            else
            {
                s->baud_phase += s->baud_rate;
                if (s->baud_phase >= SAMPLE_RATE*(100 - 40))
                {
                    if (s->last_bit < 0)
                        s->last_bit = baudstate;
                    /*endif*/
                    /* Look for the bit being consistent over the central 20% of the bit time. */
                    if (s->last_bit != baudstate)
                    {
                        s->frame_state = 0;
                    }
                    else if (s->baud_phase >= SAMPLE_RATE*100)
                    {
                        /* We should be in the middle of a baud now, so report the current
                           state as the next bit */
                        if (s->last_bit == baudstate)
                        {
                            if (++s->frame_state > s->framing_mode)
                            {
                                /* Check we have a stop bit and a start bit */
                                if (baudstate == 1  &&  (s->frame_bits & 0x02) == 0)
                                {
                                    /* Drop the start bit, and pass the rest back */
                                    s->put_bit(s->put_bit_user_data, s->frame_bits >> 2);
                                }
                                /*endif*/
                                s->frame_state = 0;
                            }
                            else
                            {
                                s->frame_bits |= (baudstate << s->framing_mode);
                                s->frame_bits >>= 1;
                            }
                            /*endif*/
                            s->baud_phase -= (SAMPLE_RATE*100);
                        }
                        else
                        {
                            s->frame_state = 0;
                        }
                        /*endif*/
                        s->last_bit = -1;
                    }
                    /*endif*/
                }
                /*endif*/
            }
            /*endif*/
            break;
        }
        /*endswitch*/
        if (++buf_ptr >= s->correlation_span)
            buf_ptr = 0;
        /*endif*/
    }
    /*endfor*/
    s->buf_ptr = buf_ptr;
    return 0;
}


static void fsk_reset(fsk_rx_state_t* s)
{
    s->state = fskIdle;
    s->fsk = 0;
    s->fsk_idx = 0;
    s->pre1_count = 0;
    s->pre2_count = 0;
    s->end_count = 0;
    s->fsk_hdr = 0;
    s->fsk_hdr_len = 0;
    s->fsk_data_len = 0;
}


static void fsk_push_bit(fsk_rx_state_t* s, int bit)
{
    int fsk;
    switch (s->state)
    {
    case fskIdle:
        if (bit)
        {
            s->pre1_count ++;
            s->state = fskPre11;
        }
        else
            fsk_reset(s);
        break;
    case fskPre11:
        if (bit)
        {
            s->pre1_count --;
            s->pre2_count ++;
            if (s->pre1_count >= s->c_min_pre1_count)
                s->state = fskPre20;
            else
                fsk_reset(s);
        }
        else
        {
            s->pre1_count ++;
            s->state = fskPre10;
        }
        break;
    case fskPre10:
        if (bit)
        {
            s->pre1_count ++;
            s->state = fskPre11;
        }
        else
            fsk_reset(s);
        break;
    case fskPre20:
        if (bit)
        {
            s->pre2_count ++;
            s->state = fskPre2;
        }
        else
        {
            s->pre1_count ++;
            s->state = fskPre10;
        }
        break;
    case fskPre2:
        if (bit)
            s->pre2_count ++;
        else if (s->pre2_count >= s->c_min_pre2_count)
            s->state = fskData0;
        else
            fsk_reset(s);
        break;
    case fskData0:
        s->fsk |= bit << s->fsk_idx;
        s->fsk_idx ++;
        s->state = fskData;
        break;
    case fskData1:
        if (!bit)
            //s->state = fskEnd1;
        //else
            s->state = fskData0;
        break;
    case fskData:
        if (s->fsk_idx == 8)
        {
            if (s->funcex)
            {
                fsk = s->fsk & 0x7f;
                if (s->fsk_hdr)
                {
                    if (!s->fsk_hdr_len)
                        s->fsk_hdr_len = fsk;
                    else
                        s->fsk_data_len ++;
                        
                    if (s->fsk_data_len < s->fsk_hdr_len)
                        s->funcex(s->funcex_user_data, fsk);
                    else
                        s->funcex(s->funcex_user_data, s->fsk);
                }
                else if (fsk == 0x4 || s->fsk == 0x80)
                {
                    if (fsk == 0x4)
                        s->fsk_hdr = fsk;
                    else if (s->fsk == 0x80)
                    {
                        s->fsk_hdr = 0x80;
                        fsk = 0x80;
                    }
                    s->funcex(s->funcex_user_data, fsk);
                }
            }

            s->fsk = 0;
            s->fsk_idx = 0;
            if (bit)
                s->state = fskData1;
            else
            {
                s->state = fskEnd0;
                s->end_count ++;
            }
        }
        else
        {
            s->fsk |= bit << s->fsk_idx;
            s->fsk_idx ++;
        }
        break;
    case fskEnd0:
        if (bit)
            fsk_reset(s);
        else
        {
            s->end_count ++;
            if (s->end_count >= s->c_min_end_count)
                fsk_reset(s);
        }
        break;
    case fskEnd1:
        if (bit)
        {
            s->end_count ++;
            if (s->end_count >= s->c_min_end_count)
                fsk_reset(s);
        }
        else
            fsk_reset(s);
        break;
    }
}
void fsk_report(void *user_data, int bit)
{
    fsk_rx_state_t *s = (fsk_rx_state_t *)user_data;
    if (bit == 0 || bit == 1)
        fsk_push_bit(s, bit);
    }
    
void fsk_report_ex(void *user_data, unsigned char fsk)
{
    fsk_rx_state_t *s = (fsk_rx_state_t *)user_data;
    if(s->fsk_count < 255 ) {//255
        s->fsks[s->fsk_count++] = fsk;
    }
}

#ifdef __cplusplus
extern "C" {
#endif


void fsk_detect_init(fsk_rx_state_t *s, fsk_spec_t *spec,int freq_zero, int freq_one, int min_level, int baud_rate, fsk_report_func_t func)
{
    spec->freq_zero  = freq_zero;
    spec->freq_one   = freq_one;
    spec->tx_level   = 0;
    spec->min_level  = min_level;
    spec->baud_rate  = baud_rate * 100; // baud rate * 100: 1200bps * 100 = 120000

    fsk_rx_init(s, spec, FSK_FRAME_MODE_SYNC, func ? func : fsk_report, s);
}

int fsk_detect(fsk_rx_state_t *s, short sample_buffer[], int samples)
{
    return fsk_rx(s, sample_buffer, samples);
}

void fsk_detect_set_param(fsk_rx_state_t *s, int min_pre1, int min_pre2, int min_end, fsk_report_func_ex_t func, void *user_data)
{
    s->c_min_pre1_count = min_pre1;
    s->c_min_pre2_count = min_pre2;
    s->c_min_end_count = min_end;
    s->funcex = func ? func : fsk_report_ex;
    s->funcex_user_data = user_data;
}

void fsk_detect_reset(fsk_rx_state_t *s, fsk_spec_t *spec)
{
    fsk_rx_restart(s, spec, FSK_FRAME_MODE_SYNC);
    fsk_reset(s);
}

int fsk_detect_get_data(fsk_rx_state_t *s, fsk_spec_t *spec, unsigned char *fsk_buf)
{
    int blastallzero = 0;
    int i=0;
    int fsk_count = 0;
    int deltatime = 0;
    if( s->fsk_count > 0){
        s->fskcurintcnt ++;
        if(s->fsk_count_old != s->fsk_count) //new data
        {
            s->fskintcnt0 = s->fskcurintcnt;
            if (s->fsk_count < 255) //255
			{
                //0,0,,
                if (s->fsk_count > 20){//20

                    blastallzero=1;
                    for (i=s->fsk_count-5;i<s->fsk_count;i++)	//50
                    {
                        if (s->fsks[i] != 0x00)
                        {
                            blastallzero=0;
                        }
                    }

                    if (blastallzero)	//50,,
                    {
                        memcpy(fsk_buf, s->fsks,s->fsk_count);
                        fsk_count = s->fsk_count;
                        fsk_detect_reset(s,spec); //
                        return fsk_count;
                    }

                }
            }
            else{
                memcpy(fsk_buf, s->fsks,s->fsk_count);
                fsk_count = s->fsk_count;
                fsk_detect_reset(s,spec);
                 return fsk_count;
            }
            s->fsk_count_old = s->fsk_count;
        }
        else//
        {
            if (s->fskcurintcnt < s->fskintcnt0)
                deltatime = 0xffffffff - s->fskintcnt0 + s->fskcurintcnt;
            else
                deltatime = s->fskcurintcnt - s->fskintcnt0;

            if (deltatime > 5 && s->fsk_count) //5 = 100ms/20ms
            {
                memcpy(fsk_buf, s->fsks,s->fsk_count);
                fsk_count = s->fsk_count;
                fsk_detect_reset(s,spec);
                return fsk_count;
            }
        }

    }
    return fsk_count;
}

int fsk_detect_data_analyze(unsigned char *  fsk_buf, int fsk_len, unsigned char * caller_id, unsigned char * date_time, unsigned char * caller_name)
{
#define SDF 0x04
#define MDF 0x80

#define TAG_TIME 0x01
#define TAG_CID  0x02
#define TAG_CIDEX 0x3
#define TAG_NCID 0x04
#define TAG_NAME 0x07
#define TAG_NNAME 0x08


    int  i;
    int  nCallIDCountFlag = 0; 
    //unsigned char ucAux;
    //unsigned char Check; 

    unsigned char ucMsgLen;
    unsigned char *puc, *pucFsk, *pucCHkSM;
    //unsigned char *pucLast = fsk_buf + fsk_len;
    //unsigned char ucFlag = 0; 
    int bFskHasCallerId = 0;

    struct _PARAMETER
    {
        unsigned char ucTypeTag;
        unsigned char ucLen;
        unsigned char parameter[1];
    }*pPMsg;


    for (i = 0, puc = fsk_buf; i < 4; i++, puc++)
    {
        if (*puc == SDF || *puc == MDF || *puc == 0) break;
    }

    if (i == 4) return -1;

    pucFsk = puc++;

    ucMsgLen = *puc;

    if (ucMsgLen == 0) return -1;

    pucCHkSM = pucFsk + ucMsgLen + 2;

    if(1)
    {
        switch (*pucFsk)
        {
        case SDF:

            if (ucMsgLen > 8)
            {
                puc = pucFsk + 2;
                memcpy(date_time, (const char *)puc, 8);
                date_time[8] = '\0';
                puc += 8;
                memcpy(caller_id, (const char*)puc, ucMsgLen - 8);
                caller_id[ucMsgLen-8] = '\0';
            }
            else
            {
                date_time[0] = '\0';
                caller_id[0] = '\0';
            }

            break;

        case MDF:
            puc = pucFsk + 2;

            while (puc < pucCHkSM)
            {
                pPMsg = (struct _PARAMETER *)puc;

                if (pPMsg->parameter + pPMsg->ucLen > pucCHkSM)
                    return -1;

                if (pPMsg->ucTypeTag == TAG_CID || pPMsg->ucTypeTag == TAG_CIDEX)
                {
                    nCallIDCountFlag++;
                }


		        if(TAG_CID == pPMsg->ucTypeTag) bFskHasCallerId = 1;

                puc = pPMsg->parameter + pPMsg->ucLen;
            }

            if (nCallIDCountFlag == 2)
            {
                puc = pucFsk + 2;

                while (puc < pucCHkSM)
                {
                    pPMsg = (struct _PARAMETER *)puc;

                    if (pPMsg->parameter + pPMsg->ucLen > pucCHkSM)
                        return -1;

                    switch (pPMsg->ucTypeTag)
                    {
                    case TAG_TIME:
                        memcpy(date_time, pPMsg->parameter, pPMsg->ucLen);
                        puc = pPMsg->parameter + pPMsg->ucLen;
                        date_time[pPMsg->ucLen] = '\0';
                        break;

                    case TAG_CID:
                    case TAG_NCID:
						

                        if(bFskHasCallerId&&TAG_NCID == pPMsg->ucTypeTag) 
                        {
                            puc = pPMsg->parameter + pPMsg->ucLen;
                            break;
                        }

                        memcpy(caller_id, pPMsg->parameter, pPMsg->ucLen);
                        puc = pPMsg->parameter + pPMsg->ucLen;
                        caller_id[pPMsg->ucLen] = '\0';
                        break;

                    case TAG_NAME:
                    case TAG_NNAME:
                        memcpy(caller_name, pPMsg->parameter, pPMsg->ucLen);
                        puc = pPMsg->parameter + pPMsg->ucLen;
                        caller_name[pPMsg->ucLen] = '\0';
                        break;

                    case TAG_CIDEX:

                    default:
                        puc = pPMsg->parameter + pPMsg->ucLen;
                        break;
                    }
                }//end of while

                break;
            }
            else
            {
                puc = pucFsk + 2;

                while (puc < pucCHkSM)
                {
                    pPMsg = (struct _PARAMETER *)puc;

                    if (pPMsg->parameter + pPMsg->ucLen > pucCHkSM)
                        return -1;

                    switch (pPMsg->ucTypeTag)
                    {
                    case TAG_TIME:
                        memcpy(date_time, pPMsg->parameter, pPMsg->ucLen);
                        puc = pPMsg->parameter + pPMsg->ucLen;
                        date_time[pPMsg->ucLen] = '\0';
                        break;

                    case TAG_CID:
                    case TAG_CIDEX: 
                    case TAG_NCID:

                        if(bFskHasCallerId&&TAG_NCID == pPMsg->ucTypeTag) 
                        {
                        puc = pPMsg->parameter + pPMsg->ucLen;
                        break;
                        }
			    
                        memcpy(caller_id, pPMsg->parameter, pPMsg->ucLen);
                        puc = pPMsg->parameter + pPMsg->ucLen;
                        caller_id[pPMsg->ucLen] = '\0';
                        break;

                    case TAG_NAME:
                    case TAG_NNAME:
                        memcpy(caller_name, pPMsg->parameter, pPMsg->ucLen);
                        puc = pPMsg->parameter + pPMsg->ucLen;
                        caller_name[pPMsg->ucLen] = '\0';
                        break;

                    default:
                        puc = pPMsg->parameter + pPMsg->ucLen;
                        break;
                    }
                }//end of while

                break;
            }

            
        }//end of switch NCID..MDF
    }

    return 1;
}

#ifdef __cplusplus
};
#endif
